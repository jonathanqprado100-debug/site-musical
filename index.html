<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>DetecÃ§Ã£o de Voz com Piano</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.min.js"></script>
  <script type="module" defer>
    import { PitchDetector } from "https://esm.sh/pitchy@4";

    let audioCtx, analyserNode, mediaStreamSource, gainNode, detector, intervalo;
    const synth = new Tone.Synth().toDestination();
    let audioInicializado = false;

    // === Tela inicial estilizada ===
    const telaEscolha = document.createElement("div");
    telaEscolha.id = "telaEscolha";
    telaEscolha.className = "tela-escolha";
    telaEscolha.innerHTML = `
      <h1>ğŸµ Bem-vindo</h1>
      <p class="subtitulo">Aplicativo por Jonathan Prado</p>
      <button id="btnEscolhaAula" class="btn-escolha">ğŸ“ Aula</button>
      <button id="btnEscolhaPiano" class="btn-escolha">ğŸ¹ Piano e Voz</button>
    `;
    document.body.prepend(telaEscolha);

    const interfacePrincipal = document.getElementById("interfacePrincipal");
    const aulaMusica = document.getElementById("aulaMusica");
    const btnIrAula = document.getElementById("btnIrAula");
    const btnVoltar = document.getElementById("btnVoltar");
    const notaCantada = document.getElementById("notaCantada");
    const gainKnob = document.getElementById("gainKnob");
    const nivelSinal = document.getElementById("nivelSinal");
    const oitavasContainer = document.getElementById("oitavasContainer");
    const pianoContainer = document.getElementById("pianoContainer");
    const btnComecar = document.getElementById("btnComecar");
    const btnParar = document.getElementById("btnParar");

    function iniciarAudio() {
      if (!audioInicializado) {
        audioCtx = new AudioContext();
        Tone.setContext(audioCtx);
        audioInicializado = true;
      }
    }

    function desbloquearAudioContext() {
      iniciarAudio();
      const buffer = audioCtx.createBuffer(1, 1, 22050);
      const source = audioCtx.createBufferSource();
      source.buffer = buffer;
      source.connect(audioCtx.destination);
      source.start(0);
    }

    // === Escolhas iniciais ===
    document.getElementById("btnEscolhaAula").addEventListener("click", () => {
      telaEscolha.style.display = "none";
      aulaMusica.style.display = "block";
      document.getElementById("btnTemaAula").style.display = "inline-block";
    });

    document.getElementById("btnEscolhaPiano").addEventListener("click", () => {
      telaEscolha.style.display = "none";
      interfacePrincipal.style.display = "block";
      document.getElementById("tituloPiano").style.display = "block";
      desbloquearAudioContext();
    });

    // === NavegaÃ§Ã£o Aula <-> Piano ===
    btnIrAula.addEventListener("click", () => {
      interfacePrincipal.style.display = "none";
      aulaMusica.style.display = "block";
      document.getElementById("btnTemaAula").style.display = "inline-block";
    });

    btnVoltar.addEventListener("click", () => {
      aulaMusica.style.display = "none";
      interfacePrincipal.style.display = "block";
      document.getElementById("tituloPiano").style.display = "block";
    });

    // === Alternar tema ===
    document.querySelectorAll(".btn-tema").forEach(btn => {
      btn.addEventListener("click", () => {
        document.body.classList.toggle("light-theme");
      });
    });

    // === FrequÃªncia -> Nota ===
    function freqParaNota(freq) {
      const notasEN = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      const notasPT = ["DÃ³","DÃ³#","RÃ©","RÃ©#","Mi","FÃ¡","FÃ¡#","Sol","Sol#","LÃ¡","LÃ¡#","Si"];
      if (!freq || freq <= 0) return '--';
      const semitons = Math.round(12 * Math.log2(freq / 440));
      const notaIndex = (semitons + 9 + 120) % 12;
      const oitava = 4 + Math.floor((semitons + 9) / 12);
      return `${notasEN[notaIndex]}${oitava} \\ ${notasPT[notaIndex]} ${oitava}`;
    }

    // === Tabela de notas por oitava (quadrados maiores, um em cima do outro) ===
    function gerarTabelaNotas() {
      const notasEN = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      const notasPT = ["DÃ³","DÃ³#","RÃ©","RÃ©#","Mi","FÃ¡","FÃ¡#","Sol","Sol#","LÃ¡","LÃ¡#","Si"];
      for (let oitava = 1; oitava <= 7; oitava++) {
        const card = document.createElement("div");
        card.classList.add("oitava-card");
        card.style.minWidth = "360px"; /* quadrado maior */
        const titulo = document.createElement("h3");
        titulo.innerText = `Oitava ${oitava}`;
        card.appendChild(titulo);
        notasEN.forEach((nota, i) => {
          const notaCard = document.createElement("div");
          notaCard.classList.add("nota-card");
          notaCard.classList.add(nota.includes("#") ? "nota-sustenida" : "nota-natural");
          notaCard.innerText = `${nota}${oitava} - ${notasPT[i]} ${oitava}`;
          notaCard.style.minWidth = "100px"; /* maior */
          card.appendChild(notaCard);
        });
        oitavasContainer.appendChild(card);
      }
    }
    gerarTabelaNotas();

    // === Piano funcional ===
    const notasSynth = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    for (let oitava = 2; oitava <= 6; oitava++) {
      notasSynth.forEach(nota => {
        const notaCompleta = `${nota}${oitava}`;
        const tecla = document.createElement("div");
        tecla.classList.add("tecla");
        tecla.classList.add(nota.includes("#") ? "tecla-sustenida" : "tecla-natural");
        tecla.innerText = notaCompleta;
        tecla.dataset.nota = notaCompleta;

        function tocarNota() {
          iniciarAudio();
          synth.triggerAttack(notaCompleta);
          highlightPiano(notaCompleta, false);
        }
        function soltarNota() {
          synth.triggerRelease();
          clearPianoHighlight();
        }

        tecla.addEventListener("mousedown", tocarNota);
        tecla.addEventListener("mouseup", soltarNota);
        tecla.addEventListener("mouseleave", soltarNota);
        tecla.addEventListener("touchstart", (e) => { e.preventDefault(); tocarNota(); }, { passive: false });
        tecla.addEventListener("touchend", (e) => { e.preventDefault(); soltarNota(); }, { passive: false });

        pianoContainer.appendChild(tecla);
      });
    }

    function highlightPiano(nota, anim = true) {
      clearPianoHighlight();
      const tecla = document.querySelector(`.tecla[data-nota="${nota}"]`);
      if (tecla) {
        if (!anim) tecla.style.transition = "none";
        tecla.classList.add("tecla-ativa");
        if (!anim) setTimeout(() => { tecla.style.transition = ""; }, 50);
      }
    }
    function clearPianoHighlight() {
      document.querySelectorAll(".tecla").forEach(t => {
        t.classList.remove("tecla-ativa");
        t.style.transition = "";
      });
    }

    // === DetecÃ§Ã£o de voz ===
    btnComecar.addEventListener("click", async () => {
      iniciarAudio();
      analyserNode = audioCtx.createAnalyser();
      analyserNode.fftSize = 4096;
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaStreamSource = audioCtx.createMediaStreamSource(stream);
      gainNode = audioCtx.createGain();
      gainNode.gain.value = parseFloat(gainKnob.value);
      mediaStreamSource.connect(gainNode).connect(analyserNode);
      detector = PitchDetector.forFloat32Array(analyserNode.fftSize);

      intervalo = setInterval(() => {
        const input = new Float32Array(analyserNode.fftSize);
        analyserNode.getFloatTimeDomainData(input);
        const [pitch, clarity] = detector.findPitch(input, audioCtx.sampleRate);
        if (clarity > 0.85 && pitch) {
          const nota = freqParaNota(pitch);
          notaCantada.innerText = `Nota cantada: ${nota} (${pitch.toFixed(1)} Hz)`;
          highlightPiano(nota.split(" \\ ")[0], false);
        } else {
          notaCantada.innerText = "Nota cantada: --";
          clearPianoHighlight();
        }
        const rms = Math.sqrt(input.reduce((sum, val) => sum + val * val, 0) / input.length);
        nivelSinal.style.width = `${Math.min(rms * 300, 100)}%`;
      }, 100);
    });

    btnParar.addEventListener("click", () => {
      clearInterval(intervalo);
      notaCantada.innerText = "Nota cantada: --";
      clearPianoHighlight();
    });

    gainKnob.addEventListener("input", () => {
      if (gainNode) gainNode.gain.value = parseFloat(gainKnob.value);
    });
  </script>
</head>
<body>
  <div class="container">

    <!-- Interface Piano -->
    <div id="interfacePrincipal" style="display:none;">
      <h1 id="tituloPiano" style="text-align:center; display:none;">ğŸ¤ DetecÃ§Ã£o de Voz com Piano</h1>
      <div style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;">
        <button class="btn-aula btn-tema">ğŸŒ— Alternar Tema</button>
        <button id="btnIrAula" class="btn-aula">ğŸ“ Ir para a Aula</button>
      </div>

      <section class="microfone">
        <h2>Detectar nota cantada</h2>
        <div class="controls">
          <button id="btnComecar" class="btn-aula">ComeÃ§ar detecÃ§Ã£o</button>
          <button id="btnParar" class="btn-aula">Parar detecÃ§Ã£o</button>
        </div>
        <p id="notaCantada">Nota cantada: --</p>
        <label for="gainKnob">Ajuste de ganho do microfone</label>
        <div id="nivelSinalContainer">
          <input id="gainKnob" type="range" min="0" max="2" step="0.01" value="1">
          <div id="nivelSinal"></div>
        </div>
      </section>

      <section class="piano-section">
        <h2>Piano (C2 - C6)</h2>
        <div id="pianoContainer"></div>
      </section>

      <section class="notas-oitavas">
        <h2>Notas por Oitava</h2>
        <div id="oitavasContainer"></div>
      </section>
    </div>

    <!-- Aula -->
   <div id="aulaMusica" style="display:none; margin-top:20px;">
  <div style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;">
    <button id="btnTemaAula" class="btn-aula btn-tema" style="display:none;">ğŸŒ— Alternar Tema</button>
    <button id="btnVoltar" class="btn-aula">â¬… Voltar</button>
  </div>

  <div class="aula-conteudo">
    <h2>ğŸ¶ Como a MÃºsica Funciona: Um Guia Simples e Direto</h2>

    <div class="aula-card">
      <h3>1. Notas Musicais: Os Blocos da MÃºsica</h3>
      <p>As notas sÃ£o como letras do alfabeto musical. Existem sete principais:<br>
      â€¢ DÃ³, RÃ©, Mi, FÃ¡, Sol, LÃ¡, Si</p>
      <p>Essas notas se repetem em diferentes alturas (sons mais graves ou mais agudos). No sistema internacional, elas tambÃ©m sÃ£o chamadas por letras:<br>
      â€¢ C (DÃ³), D (RÃ©), E (Mi), F (FÃ¡), G (Sol), A (LÃ¡), B (Si)</p>
      <p>ğŸ”¹ Exemplo: A nota LÃ¡ (ou A) Ã© usada como referÃªncia para afinar instrumentos. Ela tem uma frequÃªncia de 440 Hz â€” Ã© como o â€œponto de partidaâ€ do som.</p>
    </div>

    <div class="aula-card">
      <h3>2. ğŸ¹ Como as Notas se Conectam ao Piano</h3>
      <p>O piano tem teclas brancas e pretas. Cada tecla representa uma nota. As teclas brancas seguem a sequÃªncia DÃ³-RÃ©-Mi-FÃ¡-Sol-LÃ¡-Si. As pretas sÃ£o variaÃ§Ãµes chamadas sustenidos (#) ou bemÃ³is (â™­).</p>
      <p>ğŸ”¹ Exemplo visual: Se vocÃª encontrar duas teclas pretas juntas, a tecla branca Ã  esquerda delas Ã© o DÃ³. A partir daÃ­, vocÃª pode identificar todas as outras notas.</p>
    </div>

    <div class="aula-card">
      <h3>3. ğŸ§µ Melodia: A Linha que Costura as Notas</h3>
      <p>A melodia Ã© uma sequÃªncia de notas tocadas uma apÃ³s a outra. Ã‰ o que vocÃª canta ou reconhece numa mÃºsica.</p>
      <p>ğŸ”¹ Exemplo: Na mÃºsica â€œParabÃ©ns pra VocÃªâ€, a melodia comeÃ§a com:<br>
      DÃ³, DÃ³, RÃ©, DÃ³, FÃ¡, Mi</p>
    </div>

    <div class="aula-card">
      <h3>4. ğŸŒˆ Tom: O Clima da MÃºsica</h3>
      <p>O tom define o â€œambiente emocionalâ€ da mÃºsica. Ele Ã© baseado na nota principal e na escala usada.</p>
      <p>â€¢ Tom maior: som alegre, aberto<br>
         â€¢ Tom menor: som mais introspectivo ou triste</p>
      <p>ğŸ”¹ Exemplo: Uma mÃºsica em LÃ¡ maior soa vibrante. Uma mÃºsica em LÃ¡ menor soa mais melancÃ³lica.</p>
    </div>

    <div class="aula-card">
      <h3>5. ğŸªœ Escalas: A Escada das Notas</h3>
      <p>A escala Ã© uma sequÃªncia organizada de notas. A mais comum Ã© a escala maior, que segue este padrÃ£o de distÃ¢ncia entre notas:<br>
      Tom â€“ Tom â€“ Semitom â€“ Tom â€“ Tom â€“ Tom â€“ Semitom</p>
      <p>ğŸ”¹ Exemplo: A escala de DÃ³ maior tem:<br>
      DÃ³, RÃ©, Mi, FÃ¡, Sol, LÃ¡, Si, DÃ³</p>
    </div>

    <div class="aula-card">
      <h3>6. ğŸ¨ Harmonia: O Fundo da Pintura Musical</h3>
      <p>A harmonia acontece quando vÃ¡rias notas sÃ£o tocadas ao mesmo tempo, formando acordes. Ela dÃ¡ profundidade Ã  melodia.</p>
      <p>ğŸ”¹ Exemplo: Se a melodia estÃ¡ cantando a nota Mi, o acompanhamento pode tocar um acorde de DÃ³ maior (DÃ³, Mi, Sol).</p>
    </div>

    <div class="aula-card">
      <h3>7. ğŸ” Como Identificar Notas e Acordes</h3>
      <p>â€¢ No piano, cada tecla tem um nome.<br>
         â€¢ As notas se repetem em padrÃµes.<br>
         â€¢ Os acordes sÃ£o grupos de 3 ou mais notas que â€œsoam bem juntasâ€.</p>
      <p>ğŸ”¹ Exemplo de acorde:<br>
      DÃ³ maior = DÃ³ + Mi + Sol<br>
      LÃ¡ menor = LÃ¡ + DÃ³ + Mi</p>
    </div>
  </div>
</div>

  </div>
</body>
</html>
